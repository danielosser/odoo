/** @odoo-module **/

import { Define } from '@mail/define';

export default Define`
    {Dev/comment}
        Performs RPC on the route '/mail/get_suggested_recipients'.
    {Action}
        [Action/name]
            Thread/performRpcMailGetSuggestedRecipients
        [Action/params]
            model
                [type]
                    String
            res_ids
                [type]
                    Collection<Integer>
        [Action/behavior]
            :data
                @env
                .{Env/owlEnv}
                .{Dict/get}
                    services
                .{Dict/get}
                    rpc
                .{Function/call}
                    [0]
                        [route]
                            /mail/get_suggested_recipients
                        [params]
                            [model]
                                @model
                            [res_ids]
                                @res_ids
                    [1]
                        [shadow]
                            true
            {foreach}
                @data
            .{as}
                id
            .{do}
                :recipientInfoList
                    @data
                    .{Collection/at}
                        @id
                    .{Collection/map}
                        {func}
                            [in]
                                item
                            [out]
                                :partner_id
                                    @item
                                    .{Collection/first}
                                :emailInfo
                                    @item
                                    .{Collection/second}
                                :reason
                                    @item
                                    .{Collection/third}
                                :name
                                    {if}
                                        @emailInfo
                                    .{then}
                                        {Utils/parseEmail}
                                            @emailInfo
                                        .{Collection/first}
                                :email
                                    {if}
                                        @emailInfo
                                    .{then}
                                        {Utils/parseEmail}
                                            @emailInfo
                                        .{Collection/second}
                                [Record/traits]
                                    SuggestedRecipientInfo
                                [SuggestedRecipientInfo/email]
                                    @email
                                [SuggestedRecipientInfo/id]
                                    {Thread/getSuggestedRecipientInfoNextTemporaryId}
                                [SuggestedRecipientInfo/name]
                                    @name
                                [SuggestedRecipientInfo/partner]
                                    {if}
                                        @partner_id
                                    .{then}
                                        {Record/insert}
                                            [Record/traits]
                                                Partner
                                            [Partner/id]
                                                @partner_id
                                    .{else}
                                        {Record/empty}
                                [SuggestedRecipientInfo/reason]
                                    @reason
                {Record/insert}
                    [Record/traits]
                        Thread
                    [Thread/id]
                        @id
                    [Thread/model]
                        @model
                    [Thread/suggestedRecipientInfoList]
                        {Record/insert}
                            @recipientInfoList
`;
