/** @odoo-module **/

import { Define } from '@mail/define';

export default Define`
    {Dev/comment}
        Sends this peer notifications to send as soon as the last pending
        sending finishes.
    {Action}
        [Action/name]
            Rtc/_sendPeerNotifications
        [Action/params]
            record
                [type]
                    Rtc
        [Action/behavior]
            {if}
                @record
                .{Rtc/isNotifyPeersRPCInProgress}
            .{then}
                {break}
            {Record/update}
                [0]
                    @record
                [1]
                    [Rtc/isNotifyPeersRPCInProgress]
                        true
            {Time/wait}
                @record
                .{Rtc/peerNotificationWaitDelay}
            :peerNotifications
                @record
                .{Rtc/peerNotificationsToSend}
            {try}
                @env
                .{Env/owlEnv}
                .{Dict/get}
                    services
                .{Dict/get}
                    rpc
                .{Function/call}
                    [0]
                        [route]
                            /mail/rtc/session/notify_call_members
                        [params]
                            [peer_notifications]
                                @peerNotifications
                                .{Collection/map}
                                    {func}
                                        [in]
                                            item
                                        [out]
                                            {Record/insert}
                                                [Record/traits]
                                                    Collection
                                                [0]
                                                    @peerNotification
                                                    .{RtcPeerNotification/senderId}
                                                [1]
                                                    @peerNotification
                                                    .{RtcPeerNotification/targetTokens}
                                                [2]
                                                    {JSON/stringify}
                                                        [event]
                                                            @peerNotification
                                                            .{RtcPeerNotification/event}
                                                        [channelId]
                                                            @peerNotification
                                                            .{RtcPeerNotification/channelId}
                                                        [payload]
                                                            @peerNotification
                                                            .{RtcPeerNotification/payload}
                    [1]
                        [shadow]
                            true
                {if}
                    {Record/exists}
                        @record
                    .{isFalsy}
                .{then}
                    {break}
                {Record/update}
                    [0]
                        @record
                    [1]
                        [Rtc/peerNotificationsToSend]
                            {Field/remove}
                                @peerNotifications
            .{finally}
                {if}
                    {Record/exists}
                        @record
                .{then}
                    {Record/update}
                        [0]
                            @record
                        [1]
                            [Rtc/isNotifyPeersRPCInProgress]
                                false
                    {if}
                        @record
                        .{Rtc/peerNotificationsToSend}
                        .{Collection/length}
                        .{>}
                            0
                    .{then}
                        {Rtc/_sendPeerNotifications}
                            @record
`;
