/** @odoo-module **/

import { Define } from '@mail/define';

export default Define`
    {onChange}
        [onChange/name]
            onThreadCacheIsLoadingChanged
        [onChange/model]
            ThreadView
        [onChange/dependencies]
            ThreadView/threadCache
            .ThreadCache/isLoading
        [onChange/behavior]
            {if}
                @record
                .{ThreadView/threadCache}
                .{?}
                    .{ThreadCache/isLoading}
            .{then}
                {if}
                    @record
                    .{ThreadView/isLoading}
                    .{isFalsy}
                    .{&}
                        @record
                        .{ThreadView/isPreparingLoading}
                        .{isFalsy}
                .{then}
                    {Record/update}
                        [0]
                            @record
                        [1]
                            [ThreadView/isPreparingLoading]
                                true
                    {Record/doAsync}
                        @record
                        {func}
                            {Record/insert}
                                [Record/traits]
                                    Promise
                                {func}
                                    [in]
                                        resolve
                                    [out]
                                        {Record/update}
                                            [0]
                                                @record
                                            [1]
                                                [ThreadView/_loaderTimeout]
                                                    {web.Browser/setTimeout}
                                                        @resolve
                                                        400
                    .{Promise/then}
                        {func}
                            {Record/update}
                                [0]
                                    @record
                                [1]
                                    [ThreadView/isLoading]
                                        @record
                                        .{ThreadView/threadCache}
                                        .{?}
                                            .{ThreadCache/isLoading}
                                        .{??}
                                            false
                                    [ThreadView/isPreparingLoading]
                                        false
            .{else}
                {web.Browser/clearTimeout}
                    @record
                    .{ThreadView/_loaderTimeout}
                {Record/update}
                    [0]
                        @record
                    [1]
                        [ThreadView/isLoading]
                            false
                        [ThreadView/isPreparingLoading]
                            false
`;
