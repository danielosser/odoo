/** @odoo-module **/

import { Define } from '@mail/define';

export default Define`
    {Dev/comment}
        Update server-side subscription of subtypes of this follower.
    {Action}
        [Action/name]
            Follower/updateSubtypes
        [Action/params]
            follower
                [type]
                    Follower
        [Action/behavior]
            {if}
                @follower
                .{Follower/selectedSubtypes}
                .{Collection/length}
                .{=}
                    0
            .{then}
                {Follower/remove}
                    @follower
            .{else}
                :kwargs
                    {Record/insert}
                        [Record/traits]
                            Dict
                        [subtype_ids]
                            @follower
                            .{Follower/selectedSubtypes}
                            .{Collection/map}
                                {func}
                                    [in]
                                        item
                                    [out]
                                        @item
                                        .{FollowerSubtype/id}
                {if}
                    @follower
                    .{Follower/partner}
                .{then}
                    {Record/update}
                        [0]
                            @kwargs
                        [1]
                            [partner_ids]
                                @follower
                                .{Follower/partner}
                                .{Partner/id}
                {Record/doAsync}
                    [0]
                        @follower
                    [1]
                        {func}
                            @env
                            .{Env/owlEnv}
                            .{Dict/get}
                                services
                            .{Dict/get}
                                rpc
                            .{Function/call}
                                [model]
                                    @follower
                                    .{Follower/followedThread}
                                    .{Thread/model}
                                [method]
                                    message_subscribe
                                [args]
                                    {Record/insert}
                                        [Record/traits]
                                            Collection
                                        {Record/insert}
                                            [Record/traits]
                                                Collection
                                            @follower
                                            .{Follower/followedThread}
                                            .{Thread/id}
                                [kwargs]
                                    @kwargs
                @env
                .{Env/owlEnv}
                .{Dict/get}
                    services
                .{Dict/get}
                    notification
                .{Dict/get}
                    notify
                .{Function/call}
                    [type]
                        success
                    [message]
                        {Locale/text}
                            The subscription preferences were successfully applied.
            {Follower/closeSubtypes}
                @follower
`;
