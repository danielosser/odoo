/** @odoo-module **/

import { Define } from '@mail/define';

export default Define`
    {Action}
        [Action/name]
            Partner/_fetchImStatus
        [Action/behavior]
            :partnerIds
                {Record/insert}
                    [Record/traits]
                        Collection
            {foreach}
                {Record/all}
                    [Record/traits]
                        Partner
            .{as}
                partner
            .{do}
                {if}
                    @partner
                    .{Partner/imStatus}
                    .{!=}
                        im_partner
                    .{&}
                        @partner
                        .{Partner/id}
                        .{>}
                            0
                .{then}
                    {Collection/push}
                        [0]
                            @partnerIds
                        [1]
                            @partner
                            .{Partner/id}
            {if}
                @partnerIds
                .{Collection/length}
                .{=}
                    0
            .{then}
                {break}
            :dataList
                @env
                .{Env/owlEnv}
                .{Dict/get}
                    services
                .{Dict/get}
                    rpc
                .{Function/call}
                    [0]
                        [route]
                            /longpolling/im_status
                        [params]
                            [partner_ids]
                                @partnerIds
                    [1]
                        [shadow]
                            true
            {Record/insert}
                [Record/traits]
                    Partner
                @dataList
                .{Collection/map}
                    {func}
                        [in]
                            item
                        [out]
                            [Partner/id]
                                @item
                                .{Dict/get}
                                    id
                            [Partner/imStatus]
                                @item
                                .{Dict/get}
                                    im_status
`;
