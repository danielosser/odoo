/** @odoo-module **/

import { Define } from '@mail/define';

export default Define`
    {Dev/comment}
        Modifies the message to add the 'read more/read less' functionality
        All element nodes with 'data-o-mail-quote' attribute are concerned.
        All text nodes after a '#stopSpelling' element are concerned.
        Those text nodes need to be wrapped in a span (toggle functionality).
        All consecutive elements are joined in one 'read more/read less'.

        FIXME This method should be rewritten (task-2308951)
    {Action}
        [Action/name]
            MessageViewComponent/_insertReadMoreLess
        [Action/params]
            $element
                [type]
                    jQuery.Element
            record
                [type]
                    MessageViewComponent
        [Action/behavior]
            :groups
                {Record/insert}
                    [Record/traits]
                        Collection
            :readMoreNodes
            {Dev/comment}
                nodeType 1: element_node
                nodeType 3: text_node
            :$children
                @$element
                .{jQuery.Element/contents}
                .{Collection/filter}
                    {func}
                        [in]
                            index
                            content
                        [out]
                            @content
                            .{web.Element/nodeType}
                            .{=}
                                1
                            .{|}
                                @content
                                .{web.Element/nodeType}
                                .{=}
                                    3
                                .{&}
                                    @content
                                    .{web.Element/nodeValue}
                                    .{String/trim}
            {foreach}
                @$children
            .{as}
                child
            .{do}
                :$child
                    {Record/insert}
                        [Record/traits]
                            jQuery
                        @child
                {Dev/comment}
                    Hide Text nodes if "stopSpelling"
                {if}
                    @child
                    .{web.Element/nodeType}
                    .{=}
                        3
                    .{&}
                        @$child
                        .{jQuery.Element/prevAll}
                            [id*="stopSpelling"]
                        .{Collection/length}
                        .{>}
                        0
                .{then}
                    {Dev/comment}
                        Convert Text nodes to Element nodes
                    :$child
                        {Record/insert}
                            [Record/traits]
                                jQuery
                            [0]
                                <span>
                            [1]
                                [text]
                                    @child
                                    .{web.Element/textContent}
                                [data-o-mail-quote]
                                    1
                    @child
                    .{web.Element/parentNode}
                    .{web.Element/replaceChild}
                        [0]
                            @$child
                            .{Collection/first}
                        [1]
                            @child
                {Dev/comment}
                    Create array for each 'read more' with nodes to toggle
                {if}
                    @$child
                    .{web.Element/attr}
                        data-o-mail-quote
                    .{|}
                        @$child
                        .{jQuery.Element/get}
                            0
                        .{web.Element/nodeName}
                        .{=}
                            BR
                        .{&}
                            @$child
                            .{jQuery.Element/prev}
                                [data-o-mail-quote="1"]
                            .{Collection/length}
                            .{>}
                                0
                .{then}
                    {if}
                        @readMoreNodes
                        .{isFalsy}
                    .{then}
                        :readMoreNodes
                            {Record/insert}
                                [Record/traits]
                                    Collection
                        {Collection/push}
                            [0]
                                @groups
                            [1]
                                @readMoreNodes
                    @$child
                    .{jQuery.Element/hide}
                    {Collection/push}
                        [0]
                            @readMoreNodes
                        [1]
                            @$child
                .{else}
                    :readMoreNodes
                        undefined
                    {MessageViewComponent/_insertReadMoreLess}
                        [0]
                            @record
                        [1]
                            @$child
            {foreach}
                @groups
            .{as}
                group
            .{do}
                {Record/update}
                    [0]
                       @record
                    [1]
                        [MessageViewComponent/_lastReadMoreIndex]
                            {RecordFieldCommand/add}
                                1
                {Dev/comment}
                    Insert link just before the first node
                :$readMoreLess
                    {jQuery/create}
                        [0]
                            <a>
                        [1]
                            [class]
                                o-MessageViewComponent-readMoreLess
                            [href]
                                #
                            [text]
                                {Locale/text}
                                    read more
                    .{jQuery.Element/insertBefore}
                        @group
                        .{Collection/first}
                {Dev/comment}
                    Toggle All next nodes
                {if}
                    @record
                    .{MessageViewComponent/_isReadMoreByIndex}
                    .{Map/has}
                        @index
                    .{isFalsy}
                .{then}
                    {Map/set}
                        [0]
                            @record
                            .{MessageViewComponent/_isReadMoreByIndex}
                        [1]
                            @index
                        [2]
                            true
                :updateFromState
                    {func}
                        :isReadMore
                            @record
                            .{MessageViewComponent/_isReadMoreByIndex}
                            .{Map/get}
                                @index
                            {foreach}
                                @group
                            .{as}
                                $child
                            .{do}
                                @$child
                                .{jQuery.Element/hide}
                                @$child
                                .{jQuery.Element/toggle}
                                    @isReadMore
                                    .{isFalsy}
                            $readMoreLess
                            .{jQuery.Element/text}
                                {if}
                                    @isReadMore
                                .{then}
                                    {Locale/text}
                                        read more
                                .{else}
                                    {Locale/text}
                                        read less
                @$readMoreLess
                .{Dict/get}
                    click
                .{Function/call}
                    {func}
                        [in]
                            e
                        [out]
                            {web.Event/preventDefault}
                                @e
                            {Record/update}
                                [0]
                                    @record
                                    .{MessageViewComponent/_isReadMoreByIndex}
                                [1]
                                    {entry}
                                        [key]
                                            @index
                                        [value]
                                            @record
                                            .{MessageViewComponent/_isReadMoreByIndex}
                                            .{Map/get}
                                                @index
                                            .{isFalsy}
                            @updateFromState
                            .{Function/call}
                @updateFromState
                .{Function/call}
`;
