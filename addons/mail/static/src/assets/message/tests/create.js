/** @odoo-module **/

import { Define } from '@mail/define';

import { str_to_datetime } from 'web.time';

export default Define`
    {Test}
        [Test/name]
            create
        [Test/model]
            Message
        [Test/assertions]
            30
        [Test/scenario]
            :testEnv
                {Record/insert}
                    [Record/traits]
                        Env
            @testEnv
            .{Record/insert}
                [Record/traits]
                    Server
                [Server/data]
                    @record
                    .{Test/data}
            {Test/assert}
                [0]
                    @record
                [1]
                    @testEnv
                    .{Record/findById}
                        [Partner/id]
                            5
                    .{isFalsy}
            {Test/assert}
                [0]
                    @record
                [1]
                    @testEnv
                    .{Record/findById}
                        [Thread/id]
                            100
                        [Thread/model]
                            mail.channel
                    .{isFalsy}
            {Test/assert}
                [0]
                    @record
                [1]
                    @testEnv
                    .{Record/findById}
                        [Attachment/id]
                            750
                    .{isFalsy}
            {Test/assert}
                [0]
                    @record
                [1]
                    @testEnv
                    .{Record/findById}
                        [Message/id]
                            4000
                    .{isFalsy}

            :thread
                @testEnv
                .{Record/insert}
                    [Record/traits]
                        Thread
                    [Thread/id]
                        100
                    [Thread/model]
                        mail.channel
                    [Thread/name]
                        General
            :message
                @testEnv
                .{Record/insert}
                    [Record/traits]
                        Message
                    [Message/attachments]
                        @testEnv
                        .{Record/insert}
                            [Record/traits]
                                Attachment
                            [Attachment/filename]
                                test.txt
                            [Attachment/id]
                                750
                            [Attachment/mimetype]
                                text/plain
                            [Attachment/name]
                                test.txt
                    [Message/author]
                        @testEnv
                        .{Record/insert}
                            [Record/traits]
                                Partner
                            [Partner/displayName]
                                Demo
                            [Partner/id]
                                5
                    [Message/body]
                        <p>Test</p>
                    [Message/date]
                        {Record/insert}
                            [Record/traits]
                                Moment
                            {String/toDatetime}
                                2019-05-05 10:00:00
                    [Message/id]
                        4000
                    [Message/isNeedaction]
                        true
                    [Message/isStarred]
                        true
                    [Message/originThread]
                        @thread
            {Test/assert}
                [0]
                    @record
                [1]
                    @testEnv
                    .{Record/findById}
                        [Partner/id]
                            5
            {Test/assert}
                [0]
                    @record
                [1]
                    @testEnv
                    .{Record/findById}
                        [Thread/id]
                            100
                        [Thread/model]
                            mail.channel
            {Test/assert}
                [0]
                    @record
                [1]
                    @testEnv
                    .{Record/findById}
                        [Attachment/id]
                            750
            {Test/assert}
                [0]
                    @record
                [1]
                    @testEnv
                    .{Record/findById}
                        [Message/id]
                            4000
            {Test/assert}
                [0]
                    @record
                [1]
                    @message
            {Test/assert}
                [0]
                    @record
                [1]
                    @testEnv
                    .{Record/findById}
                        [Message/id]
                            4000
                    .{=}
                        @message
            {Test/assert}
                [0]
                    @record
                [1]
                    @message
                    .{Message/body}
                    .{=}
                        <p>Test</p>
            {Test/assert}
                [0]
                    @record
                [1]
                    {Record/insert}
                        [Record/traits]
                            Moment
                        @message
                        .{Message/date}
                    .{Moment/utc}
                    .{Moment/format}
                        YYYY-MM-DD hh:mm:ss
                    .{=}
                        2019-05-05 10:00:00
            {Test/assert}
                [0]
                    @record
                [1]
                    @message
                    .{Message/id}
                    .{=}
                        4000
            {Test/assert}
                [0]
                    @record
                [1]
                    @message
                    .{Message/originThread}
                    .{=}
                        @testEnv
                        .{Record/findById}
                            [Thread/id]
                                100
                            [Thread/model]
                                mail.channel
            {Test/assert}
                [0]
                    @record
                [1]
                    @message
                    .{Message/threads}
                    .{Collection/includes}
                        @testEnv
                        .{Record/findById}
                            [Thread/id]
                                100
                            [Thread/model]
                                mail.channel
            {Dev/comment}
                from partnerId being in needaction_partner_ids
            {Test/assert}
                [0]
                    @record
                [1]
                    @message
                    .{Message/threads}
                    .{Collection/includes}
                        @testEnv
                        .{Env/inbox}
            {Dev/comment}
                from partnerId being in starred_partner_ids
            {Test/assert}
                [0]
                    @record
                [1]
                    @message
                    .{Message/threads}
                    .{Collection/includes}
                        @testEnv
                        .{Env/starred}
            :attachment
                @testEnv
                .{Record/findById}
                    [Attachment/id]
                        750
            {Test/assert}
                [0]
                    @record
                [1]
                    @attachment
            {Test/assert}
                [0]
                    @record
                [1]
                    @attachment
                    .{Attachment/filename}
                    .{=}
                        test.txt
            {Test/assert}
                [0]
                    @record
                [1]
                    @attachment
                    .{Attachment/id}
                    .{=}
                        750
            {Test/assert}
                [0]
                    @record
                [1]
                    @attachment
                    .{Attachment/isUploading}
                    .{isFalsy}
            {Test/assert}
                [0]
                    @record
                [1]
                    @attachment
                    .{Attachment/mimetype}
                    .{=}
                        text/plain
            {Test/assert}
                [0]
                    @record
                [1]
                    @attachment
                    .{Attachment/name}
                    .{=}
                        test.txt
            :channel
                @testEnv
                .{Record/findById}
                    [Thread/id]
                        100
                    [Thread/model]
                        mail.channel
            {Test/assert}
                [0]
                    @record
                [1]
                    @channel
            {Test/assert}
                [0]
                    @record
                [1]
                    @channel
                    .{Thread/model}
                    .{=}
                        mail.channel
            {Test/assert}
                [0]
                    @record
                [1]
                    @channel
                    .{Thread/id}
                    .{=}
                        100
            {Test/assert}
                [0]
                    @record
                [1]
                    @channel
                    .{Thread/name}
                    .{=}
                        General
            :partner
                @testEnv
                .{Record/findById}
                    [Partner/id]
                        5
            {Test/assert}
                [0]
                    @record
                [1]
                    @partner
            {Test/assert}
                [0]
                    @record
                [1]
                    @partner
                    .{Partner/displayName}
                    .{=}
                        Demo
            {Test/assert}
                [0]
                    @record
                [1]
                    @partner
                    .{Partner/id}
                    .{=}
                        5
`;
