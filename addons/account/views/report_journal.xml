<?xml version="1.0" encoding="utf-8"?>
<odoo>
<template id="report_journal">
    <t t-call="web.html_container">
        <t t-set="data_report_margin_top" t-value="12"/>
        <t t-set="data_report_header_spacing" t-value="9"/>
        <t t-set="data_report_dpi" t-value="110"/>
        <t t-foreach="docs" t-as="o">
            <t t-if="lines[o.id]">
                <t t-if="not o" t-set="o" t-value="doc"/>

                <t t-if="not company">
                    <!-- Multicompany -->
                    <t t-if="company_id">
                        <t t-set="company" t-value="company_id"/>
                    </t>
                    <t t-elif="o and 'company_id' in o and o.company_id.sudo()">
                        <t t-set="company" t-value="o.company_id.sudo()"/>
                    </t>
                    <t t-else="else">
                        <t t-set="company" t-value="res_company"/>
                    </t>
                </t>

                <div class="header">
                    <div class="row">
                        <div class="col-3">
                            <span t-esc="context_timestamp(datetime.datetime.now()).strftime('%Y-%m-%d %H:%M')"/>
                        </div>
                        <div class="col-4 offset-1 text-center">
                            <span t-esc="company.name"/> / <span t-esc="o.name"/>
                        </div>
                        <div class="col-2 offset-2 text-right">
                            <ul class="list-inline">
                                <li class="list-inline-item"><span class="page"/></li>
                                <li class="list-inline-item">/</li>
                                <li class="list-inline-item"><span class="topage"/></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="article" t-att-data-oe-model="o and o._name" t-att-data-oe-id="o and o.id" t-att-data-oe-lang="o and o.env.context.get('lang')">
                    <div class="page">
                    <h2><t t-esc="o.name"/> Journal <span t-if="data['form']['target_move'] == 'all'">- Draft included</span></h2>
                    <table class="table table-sm table-striped mt-4">
                        <thead>
                            <tr>
                                <th t-if="data['form'].get('sort_selection') == 'move_name'">Move</th>
                                <th t-if="data['form'].get('sort_selection') == 'move_name'">Date</th>
                                <th t-if="data['form'].get('sort_selection') == 'date'">Date</th>
                                <th t-if="data['form'].get('sort_selection') == 'date'">Move</th>
                                <th>Partner</th>
                                <th>Account</th>
                                <th>Label</th>
                                <th t-if="data['form']['amount_currency']" class="text-right">Currency</th>
                                <th class="text-right">Debit</th>
                                <th class="text-right">Credit</th>
                                <th>Tax Grid</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-set="last_am" t-value=""/>
                            <t t-set="last_date" t-value=""/>
                            <t t-set="last_partner" t-value=""/>
                            <tr t-foreach="lines[o.id]" t-as="aml">
                                <t t-if="data['form'].get('sort_selection') == 'move_name'">
                                    <t t-set="am_name" t-value="aml.move_id.name != '/' and aml.move_id.name or ('*'+str(aml.move_id.id))"/>
                                    <t t-if="last_am == am_name">
                                        <td/>
                                    </t>
                                    <t t-else="">
                                        <td><span t-esc="am_name" class="font-weight-bold"/></td>
                                        <t t-set="last_am" t-value="am_name"/>
                                        <!-- Reset these when changing move -->
                                        <t t-set="last_date" t-value=""/>
                                        <t t-set="last_partner" t-value=""/>
                                    </t>
                                    <t t-if="last_date == aml.date">
                                        <td/>
                                    </t>
                                    <t t-else="">
                                        <td><span t-field="aml.date"/></td>
                                        <t t-set="last_date" t-value="aml.date"/>
                                    </t>
                                </t>
                                <t t-else="">
                                    <t t-set="am_name" t-value="aml.move_id.name != '/' and aml.move_id.name or ('*'+str(aml.move_id.id))"/>
                                    <t t-if="last_date == aml.date and last_am == am_name">
                                        <td/>
                                    </t>
                                    <t t-else="">
                                        <td><span t-field="aml.date" class="font-weight-bold"/></td>
                                        <t t-set="last_date" t-value="aml.date"/>
                                        <!-- Reset these when changing data -->
                                        <t t-set="last_am" t-value=""/>
                                        <t t-set="last_partner" t-value=""/>
                                    </t>
                                    <t t-if="last_am == am_name">
                                        <td/>
                                    </t>
                                    <t t-else="">
                                        <td><span t-esc="am_name"/></td>
                                        <t t-set="last_am" t-value="am_name"/>
                                        <t t-set="last_partner" t-value=""/>
                                    </t>
                                </t>
                                <t t-set="partner_name" t-value="aml.sudo().partner_id and aml.sudo().partner_id.name and aml.sudo().partner_id.name[:23] or ''"/>
                                <!-- general journals always show partners, as we can have multiple != ones in a single move -->
                                <t t-if="last_partner == partner_name and o.type != 'general'">
                                    <td/>
                                </t>
                                <t t-else="">
                                    <td><span t-esc="partner_name"/></td>
                                    <t t-set="last_partner" t-value="partner_name"/>
                                </t>
                                <td><span t-field="aml.account_id.code"/></td>
                                <td><span t-esc="aml.name and aml.name[:35]"/></td>
                                <td t-if="data['form']['amount_currency'] and aml.amount_currency" class="pull-right">
                                    <span t-esc="aml.amount_currency" t-options="{'widget': 'monetary', 'display_currency': aml.currency_id}"/>
                                </td>
                                <td><span t-if="not (company_id or res_company).currency_id.is_zero(aml.debit)" t-esc="aml.debit" t-options="{'widget': 'monetary', 'display_currency': (company_id or res_company).currency_id}" class="pull-right"/></td>
                                <td><span t-if="not (company_id or res_company).currency_id.is_zero(aml.credit)" t-esc="aml.credit" t-options="{'widget': 'monetary', 'display_currency': (company_id or res_company).currency_id}" class="pull-right"/></td>
                                <td>
                                    <span t-foreach="aml.tax_tag_ids" t-as="tax_tag_id">
                                        <span t-esc="tax_tag_id.name"/>
                                    </span>
                                </td>
                            </tr>
                            <tr class="bg-white">
                                <td/>
                                <td/>
                                <td/>
                                <td/>
                                <td class="text-right"><strong>Total</strong></td>
                                <td>
                                    <span t-esc="sum_debits.get(o.id, 0)"
                                          t-options="{
                                            'widget': 'monetary',
                                            'display_currency': (company_id or res_company).currency_id
                                          }"
                                          class="pull-right font-weight-bold"/>
                                </td>
                                <td>
                                    <span t-esc="sum_credits.get(o.id, 0)"
                                          t-options="{
                                              'widget': 'monetary',
                                              'display_currency': (company_id or res_company).currency_id
                                          }"
                                          class="pull-right font-weight-bold"/>

                                </td>
                                <td t-if="data['form']['amount_currency']"/>
                                <td/>
                            </tr>
                        </tbody>
                    </table>

                    <div class="row" style="page-break-inside: avoid">
                        <t t-set="taxes" t-value="taxes_details.get(o.id)"/>
                        <div class="col-4" t-if="taxes">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr><th colspan="3">Tax Declaration</th></tr>
                                    <tr>
                                        <th>Name</th>
                                        <th class="text-right">Base Amount</th>
                                        <th class="text-right">Tax Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="taxes" t-as="tax">
                                        <td><span t-esc="tax.name"/></td>
                                        <td><span t-esc="taxes[tax]['base_amount']" t-options="{'widget': 'monetary', 'display_currency': (company_id or res_company).currency_id}" class="pull-right"/></td>
                                        <td><span t-esc="taxes[tax]['tax_amount']" t-options="{'widget': 'monetary', 'display_currency': (company_id or res_company).currency_id}" class="pull-right"/></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <t t-set="grids" t-value="tax_grid_details.get(o.id)"/>
                        <div class="col-4" t-if="grids">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr><th colspan="4">Impacted Tax Grid</th></tr>
                                    <tr>
                                        <th>Grid</th>
                                        <th class="text-right">+</th>
                                        <th class="text-right">-</th>
                                        <th class="text-right">Impact On Grid</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="grids" t-as="grid">
                                        <td><span t-esc="grids[grid]['grid']"/></td>
                                        <td>
                                            <span t-esc="grids[grid].get('+', 0)"
                                                  t-options="{
                                                      'widget': 'monetary',
                                                      'display_currency': (company_id or res_company).currency_id
                                                  }"
                                                  class="pull-right"/>
                                        </td>
                                        <td>
                                            <span t-esc="grids[grid].get('-', 0)"
                                                  t-options="{
                                                      'widget': 'monetary',
                                                      'display_currency': (company_id or res_company).currency_id
                                                  }"
                                                  class="pull-right"/>
                                        </td>
                                        <td>
                                            <span t-esc="grids[grid]['impact']"
                                                  t-options="{
                                                      'widget': 'monetary',
                                                      'display_currency': (company_id or res_company).currency_id
                                                  }"
                                                  class="pull-right"/>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
                </div>
            </t>
        </t>
    </t>
</template>
</odoo>
